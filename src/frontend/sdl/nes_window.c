/** * @file nes_window.c * @brief Implementação da janela principal do emulador NES usando SDL2 */#include <SDL2/SDL.h>#include <stdbool.h>#include <stdio.h>#include <stdlib.h>#include <string.h>#include "frontend/sdl/nes_window.h"#include "platforms/nes/nes.h"#include "platforms/nes/input/nes_input.h"#include "platforms/nes/nes_config.h"#include "utils/enhanced_log.h"#include "frontend/renderer/nes_renderer.h"#define WINDOW_SCALE 3#define WINDOW_WIDTH (NES_SCREEN_WIDTH * WINDOW_SCALE)#define WINDOW_HEIGHT (NES_SCREEN_HEIGHT * WINDOW_SCALE)#define AUDIO_SAMPLE_RATE 44100#define AUDIO_BUFFER_SIZE (AUDIO_SAMPLE_RATE / 60)typedef struct{    SDL_Window *window;    SDL_Renderer *renderer;    SDL_Texture *screen_texture;    SDL_AudioDeviceID audio_device;    uint32_t *frame_buffer;    int16_t *audio_buffer;    bool running;    bool fullscreen;    int scale_factor;} nes_window_t;static void audio_callback(void *userdata, Uint8 *stream, int len){    nes_window_t *nes_window = (nes_window_t *)userdata;    if (nes_window && nes_window->audio_buffer)    {        SDL_memcpy(stream, nes_window->audio_buffer, len);    }    else    {        SDL_memset(stream, 0, len);    }}static void handle_input(uint8_t *button_state){    const uint8_t *keyboard = SDL_GetKeyboardState(NULL);    *button_state = 0;    if (keyboard[SDL_SCANCODE_Z])        *button_state |= NES_BUTTON_A;    if (keyboard[SDL_SCANCODE_X])        *button_state |= NES_BUTTON_B;    if (keyboard[SDL_SCANCODE_RETURN])        *button_state |= NES_BUTTON_START;    if (keyboard[SDL_SCANCODE_RSHIFT])        *button_state |= NES_BUTTON_SELECT;    if (keyboard[SDL_SCANCODE_UP])        *button_state |= NES_BUTTON_UP;    if (keyboard[SDL_SCANCODE_DOWN])        *button_state |= NES_BUTTON_DOWN;    if (keyboard[SDL_SCANCODE_LEFT])        *button_state |= NES_BUTTON_LEFT;    if (keyboard[SDL_SCANCODE_RIGHT])        *button_state |= NES_BUTTON_RIGHT;}static int init_nes_window(nes_window_t *window){    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Inicializando janela do NES...");    // Verificar drivers de vídeo disponíveis    int num_drivers = SDL_GetNumVideoDrivers();    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Drivers de vídeo disponíveis:");    for (int i = 0; i < num_drivers; i++)    {        EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "  %d: %s", i, SDL_GetVideoDriver(i));    }    // Verificar driver atual    const char *current_driver = SDL_GetCurrentVideoDriver();    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Driver de vídeo atual: %s", current_driver ? current_driver : "nenhum");    // DIAGNÓSTICO: Verificar versão do SDL    SDL_version compiled;    SDL_version linked;    SDL_VERSION(&compiled);    SDL_GetVersion(&linked);    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Versão SDL compilada: %d.%d.%d", compiled.major, compiled.minor, compiled.patch);    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Versão SDL em execução: %d.%d.%d", linked.major, linked.minor, linked.patch);    // DIAGNÓSTICO: Configurar variáveis de ambiente SDL    SDL_SetHint(SDL_HINT_RENDER_DRIVER, "opengl");    SDL_SetHint(SDL_HINT_VIDEO_MINIMIZE_ON_FOCUS_LOSS, "0");    SDL_SetHint(SDL_HINT_VIDEO_ALLOW_SCREENSAVER, "0");    SDL_SetHint(SDL_HINT_RENDER_SCALE_QUALITY, "nearest");    if (SDL_Init(SDL_INIT_VIDEO | SDL_INIT_AUDIO) < 0)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao inicializar SDL: %s", SDL_GetError());        return -1;    }    // Verificar driver após inicialização    current_driver = SDL_GetCurrentVideoDriver();    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Driver de vídeo após inicialização: %s", current_driver ? current_driver : "nenhum");    // Criar janela    window->window = SDL_CreateWindow(        "Mega_Emu - NES Emulator",        SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED,        WINDOW_WIDTH, WINDOW_HEIGHT,        SDL_WINDOW_SHOWN | SDL_WINDOW_RESIZABLE);    if (!window->window)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao criar janela: %s", SDL_GetError());        SDL_Quit();        return -1;    }    // Criar renderer    window->renderer = SDL_CreateRenderer(        window->window, -1,        SDL_RENDERER_ACCELERATED | (NES_ENABLE_VSYNC ? SDL_RENDERER_PRESENTVSYNC : 0));    if (!window->renderer)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao criar renderer: %s", SDL_GetError());        SDL_DestroyWindow(window->window);        SDL_Quit();        return -1;    }    // Configurar qualidade de renderização    SDL_SetHint(SDL_HINT_RENDER_SCALE_QUALITY, "nearest");    SDL_RenderSetLogicalSize(window->renderer, NES_SCREEN_WIDTH, NES_SCREEN_HEIGHT);    // Criar textura para o framebuffer    window->screen_texture = SDL_CreateTexture(        window->renderer,        SDL_PIXELFORMAT_ARGB8888,        SDL_TEXTUREACCESS_STREAMING,        NES_SCREEN_WIDTH, NES_SCREEN_HEIGHT);    if (!window->screen_texture)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao criar textura: %s", SDL_GetError());        SDL_DestroyRenderer(window->renderer);        SDL_DestroyWindow(window->window);        SDL_Quit();        return -1;    }    // Alocar framebuffer    window->frame_buffer = (uint32_t *)malloc(NES_SCREEN_WIDTH * NES_SCREEN_HEIGHT * sizeof(uint32_t));    if (!window->frame_buffer)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao alocar framebuffer");        SDL_DestroyTexture(window->screen_texture);        SDL_DestroyRenderer(window->renderer);        SDL_DestroyWindow(window->window);        SDL_Quit();        return -1;    }    // Configurar áudio    SDL_AudioSpec want, have;    SDL_memset(&want, 0, sizeof(want));    want.freq = AUDIO_SAMPLE_RATE;    want.format = AUDIO_S16SYS;    want.channels = 1;    want.samples = AUDIO_BUFFER_SIZE;    want.callback = audio_callback;    want.userdata = window;    window->audio_device = SDL_OpenAudioDevice(NULL, 0, &want, &have, 0);    if (window->audio_device == 0)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao abrir dispositivo de áudio: %s", SDL_GetError());        free(window->frame_buffer);        SDL_DestroyTexture(window->screen_texture);        SDL_DestroyRenderer(window->renderer);        SDL_DestroyWindow(window->window);        SDL_Quit();        return -1;    }    // Alocar buffer de áudio    window->audio_buffer = (int16_t *)malloc(AUDIO_BUFFER_SIZE * sizeof(int16_t));    if (!window->audio_buffer)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao alocar buffer de áudio");        SDL_CloseAudioDevice(window->audio_device);        free(window->frame_buffer);        SDL_DestroyTexture(window->screen_texture);        SDL_DestroyRenderer(window->renderer);        SDL_DestroyWindow(window->window);        SDL_Quit();        return -1;    }    // Inicializar outros campos    window->running = true;    window->fullscreen = false;    window->scale_factor = WINDOW_SCALE;    // Iniciar reprodução de áudio    SDL_PauseAudioDevice(window->audio_device, 0);    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Janela do NES inicializada com sucesso");    return 0;}static void cleanup_nes_window(nes_window_t *window){    if (!window)        return;    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Finalizando janela do NES...");    // Parar reprodução de áudio    if (window->audio_device)    {        SDL_PauseAudioDevice(window->audio_device, 1);        SDL_CloseAudioDevice(window->audio_device);    }    // Liberar recursos    if (window->audio_buffer)    {        free(window->audio_buffer);        window->audio_buffer = NULL;    }    if (window->frame_buffer)    {        free(window->frame_buffer);        window->frame_buffer = NULL;    }    if (window->screen_texture)    {        SDL_DestroyTexture(window->screen_texture);        window->screen_texture = NULL;    }    if (window->renderer)    {        SDL_DestroyRenderer(window->renderer);        window->renderer = NULL;    }    if (window->window)    {        SDL_DestroyWindow(window->window);        window->window = NULL;    }    SDL_Quit();    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Janela do NES finalizada");}static void toggle_fullscreen(nes_window_t *window){    window->fullscreen = !window->fullscreen;    SDL_SetWindowFullscreen(window->window, window->fullscreen ? SDL_WINDOW_FULLSCREEN_DESKTOP : 0);    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Modo de tela cheia: %s", window->fullscreen ? "ativado" : "desativado");}static void change_scale(nes_window_t *window, int delta){    window->scale_factor += delta;    if (window->scale_factor < 1)        window->scale_factor = 1;    if (window->scale_factor > 5)        window->scale_factor = 5;    if (!window->fullscreen)    {        SDL_SetWindowSize(window->window, NES_SCREEN_WIDTH * window->scale_factor, NES_SCREEN_HEIGHT * window->scale_factor);        SDL_SetWindowPosition(window->window, SDL_WINDOWPOS_CENTERED, SDL_WINDOWPOS_CENTERED);    }    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Fator de escala: %d", window->scale_factor);}int32_t run_nes_emulator(const char *rom_path){    nes_window_t window = {0};    nes_config_t nes_config = {0};    uint8_t controller_state = 0;    SDL_Event event;    // Inicializar janela    if (init_nes_window(&window) != 0)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Falha ao inicializar janela do NES");        return -1;    }    // Configurar emulador NES    nes_config.audio_enabled = NES_ENABLE_AUDIO;    nes_config.audio_sample_rate = AUDIO_SAMPLE_RATE;    nes_config.video_scale = window.scale_factor;    nes_config.vsync_enabled = NES_ENABLE_VSYNC;    nes_config.fullscreen = window.fullscreen;    nes_config.filter_type = 0; // Sem filtro    nes_config.region = NES_DEFAULT_REGION;    nes_config.ntsc_mode = (nes_config.region == EMU_REGION_NTSC);    nes_config.log_level = EMU_LOG_LEVEL_INFO;    nes_config.rom_path = rom_path;    // Inicializar emulador NES    if (nes_init(&nes_config) != 0)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Falha ao inicializar emulador NES");        cleanup_nes_window(&window);        return -1;    }    // Carregar ROM    if (nes_load_rom(rom_path) != 0)    {        EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Falha ao carregar ROM: %s", rom_path);        nes_shutdown();        cleanup_nes_window(&window);        return -1;    }    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "ROM carregada com sucesso: %s", rom_path);    EMU_LOG_INFO(EMU_LOG_CAT_FRONTEND, "Iniciando loop principal...");    // Loop principal    uint32_t frame_start, frame_time;    const uint32_t target_frame_time = 1000 / (nes_config.ntsc_mode ? NES_NTSC_FPS : NES_PAL_FPS);    while (window.running)    {        frame_start = SDL_GetTicks();        // Processar eventos        while (SDL_PollEvent(&event))        {            switch (event.type)            {            case SDL_QUIT:                window.running = false;                break;            case SDL_KEYDOWN:                switch (event.key.keysym.sym)                {                case SDLK_ESCAPE:                    window.running = false;                    break;                case SDLK_f:                    toggle_fullscreen(&window);                    break;                case SDLK_PLUS:                case SDLK_EQUALS:                    change_scale(&window, 1);                    break;                case SDLK_MINUS:                    change_scale(&window, -1);                    break;                case SDLK_r:                    nes_reset();                    break;                }                break;            case SDL_WINDOWEVENT:                if (event.window.event == SDL_WINDOWEVENT_RESIZED)                {                    // Ajustar viewport para manter proporção                    int w = event.window.data1;                    int h = event.window.data2;                    float window_aspect = (float)w / h;                    float nes_aspect = (float)NES_SCREEN_WIDTH / NES_SCREEN_HEIGHT;                    SDL_Rect viewport;                    if (window_aspect > nes_aspect)                    {                        viewport.h = h;                        viewport.w = (int)(h * nes_aspect);                    }                    else                    {                        viewport.w = w;                        viewport.h = (int)(w / nes_aspect);                    }                    viewport.x = (w - viewport.w) / 2;                    viewport.y = (h - viewport.h) / 2;                    SDL_RenderSetViewport(window.renderer, &viewport);                }                break;            }        }        // Processar entrada        handle_input(&controller_state);        nes_set_controller1(controller_state);        // Executar um frame do emulador        if (nes_run_frame(window.frame_buffer, window.audio_buffer, AUDIO_BUFFER_SIZE) != 0)        {            EMU_LOG_ERROR(EMU_LOG_CAT_FRONTEND, "Erro ao executar frame do emulador");            break;        }        // Atualizar textura com o framebuffer        SDL_UpdateTexture(window.screen_texture, NULL, window.frame_buffer, NES_SCREEN_WIDTH * sizeof(uint32_t));        // Renderizar        SDL_RenderClear(window.renderer);        SDL_RenderCopy(window.renderer, window.screen_texture, NULL, NULL);        SDL_RenderPresent(window.renderer);        // Controle de FPS        frame_time = SDL_GetTicks() - frame_start;        if (frame_time < target_frame_time)        {            SDL_Delay(target_frame_time - frame_time);        }    }    // Finalizar    nes_shutdown();    cleanup_nes_window(&window);    return 0;}