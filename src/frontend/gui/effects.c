#include "effects.h"#include <stdlib.h>#include <math.h>#include <SDL2/SDL.h>#include <SDL2/SDL_opengl.h>#include <GL/glew.h>#include "utils/log.h"// Shadersstatic const char *blur_vertex_shader =    "#version 330 core\n"    "layout (location = 0) in vec3 aPos;\n"    "layout (location = 1) in vec2 aTexCoord;\n"    "out vec2 TexCoord;\n"    "void main() {\n"    "    gl_Position = vec4(aPos, 1.0);\n"    "    TexCoord = aTexCoord;\n"    "}\n";static const char *blur_fragment_shader =    "#version 330 core\n"    "in vec2 TexCoord;\n"    "out vec4 FragColor;\n"    "uniform sampler2D screenTexture;\n"    "uniform float blurSize;\n"    "void main() {\n"    "    vec2 texelSize = 1.0 / textureSize(screenTexture, 0);\n"    "    vec4 result = vec4(0.0);\n"    "    for(int x = -2; x <= 2; x++) {\n"    "        for(int y = -2; y <= 2; y++) {\n"    "            vec2 offset = vec2(float(x), float(y)) * texelSize * blurSize;\n"    "            result += texture(screenTexture, TexCoord + offset);\n"    "        }\n"    "    }\n"    "    FragColor = result / 25.0;\n"    "}\n";static const char *bloom_fragment_shader =    "#version 330 core\n"    "in vec2 TexCoord;\n"    "out vec4 FragColor;\n"    "uniform sampler2D screenTexture;\n"    "uniform float threshold;\n"    "uniform float intensity;\n"    "void main() {\n"    "    vec4 color = texture(screenTexture, TexCoord);\n"    "    float brightness = dot(color.rgb, vec3(0.2126, 0.7152, 0.0722));\n"    "    if(brightness > threshold) {\n"    "        FragColor = color * intensity;\n"    "    } else {\n"    "        FragColor = vec4(0.0);\n"    "    }\n"    "}\n";static const char *distortion_fragment_shader =    "#version 330 core\n"    "in vec2 TexCoord;\n"    "out vec4 FragColor;\n"    "uniform sampler2D screenTexture;\n"    "uniform float time;\n"    "uniform float amount;\n"    "void main() {\n"    "    vec2 uv = TexCoord;\n"    "    uv.x += sin(uv.y * 10.0 + time) * amount;\n"    "    uv.y += cos(uv.x * 10.0 + time) * amount;\n"    "    FragColor = texture(screenTexture, uv);\n"    "}\n";static const char *scanline_fragment_shader =    "#version 330 core\n"    "in vec2 TexCoord;\n"    "out vec4 FragColor;\n"    "uniform sampler2D screenTexture;\n"    "uniform float scanlineIntensity;\n"    "uniform float scanlineCount;\n"    "void main() {\n"    "    vec4 color = texture(screenTexture, TexCoord);\n"    "    float scanline = sin(TexCoord.y * scanlineCount) * 0.5 + 0.5;\n"    "    color.rgb *= 1.0 - (1.0 - scanline) * scanlineIntensity;\n"    "    FragColor = color;\n"    "}\n";typedef struct{    GLuint program;    GLuint vao;    GLuint vbo;    GLuint fbo;    GLuint texture;} shader_effect_t;static shader_effect_t blur_effect;static shader_effect_t bloom_effect;static shader_effect_t distortion_effect;static shader_effect_t scanline_effect;static GLuint compile_shader(const char *source, GLenum type){    GLuint shader = glCreateShader(type);    glShaderSource(shader, 1, &source, NULL);    glCompileShader(shader);    GLint success;    glGetShaderiv(shader, GL_COMPILE_STATUS, &success);    if (!success)    {        char info_log[512];        glGetShaderInfoLog(shader, 512, NULL, info_log);        LOG_ERROR("Falha ao compilar shader: %s", info_log);        return 0;    }    return shader;}static GLuint create_shader_program(const char *vertex_source, const char *fragment_source){    GLuint vertex_shader = compile_shader(vertex_source, GL_VERTEX_SHADER);    GLuint fragment_shader = compile_shader(fragment_source, GL_FRAGMENT_SHADER);    if (!vertex_shader || !fragment_shader)    {        return 0;    }    GLuint program = glCreateProgram();    glAttachShader(program, vertex_shader);    glAttachShader(program, fragment_shader);    glLinkProgram(program);    GLint success;    glGetProgramiv(program, GL_LINK_STATUS, &success);    if (!success)    {        char info_log[512];        glGetProgramInfoLog(program, 512, NULL, info_log);        LOG_ERROR("Falha ao linkar programa: %s", info_log);        return 0;    }    glDeleteShader(vertex_shader);    glDeleteShader(fragment_shader);    return program;}static void setup_quad(shader_effect_t *effect){    float vertices[] = {        // Posições    // Coordenadas de textura        -1.0f, 1.0f, 0.0f, 0.0f, 1.0f,        -1.0f, -1.0f, 0.0f, 0.0f, 0.0f,        1.0f, -1.0f, 0.0f, 1.0f, 0.0f,        1.0f, 1.0f, 0.0f, 1.0f, 1.0f};    glGenVertexArrays(1, &effect->vao);    glGenBuffers(1, &effect->vbo);    glBindVertexArray(effect->vao);    glBindBuffer(GL_ARRAY_BUFFER, effect->vbo);    glBufferData(GL_ARRAY_BUFFER, sizeof(vertices), vertices, GL_STATIC_DRAW);    glVertexAttribPointer(0, 3, GL_FLOAT, GL_FALSE, 5 * sizeof(float), (void *)0);    glEnableVertexAttribArray(0);    glVertexAttribPointer(1, 2, GL_FLOAT, GL_FALSE, 5 * sizeof(float), (void *)(3 * sizeof(float)));    glEnableVertexAttribArray(1);}static void setup_framebuffer(shader_effect_t *effect, int width, int height){    glGenFramebuffers(1, &effect->fbo);    glBindFramebuffer(GL_FRAMEBUFFER, effect->fbo);    glGenTextures(1, &effect->texture);    glBindTexture(GL_TEXTURE_2D, effect->texture);    glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA, GL_UNSIGNED_BYTE, NULL);    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_LINEAR);    glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_LINEAR);    glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, effect->texture, 0);    if (glCheckFramebufferStatus(GL_FRAMEBUFFER) != GL_FRAMEBUFFER_COMPLETE)    {        LOG_ERROR("Falha ao criar framebuffer");    }}int gui_effects_init(int width, int height){    glewInit();    // Inicializar efeito de blur    blur_effect.program = create_shader_program(blur_vertex_shader, blur_fragment_shader);    setup_quad(&blur_effect);    setup_framebuffer(&blur_effect, width, height);    // Inicializar efeito de bloom    bloom_effect.program = create_shader_program(blur_vertex_shader, bloom_fragment_shader);    setup_quad(&bloom_effect);    setup_framebuffer(&bloom_effect, width, height);    // Inicializar efeito de distorção    distortion_effect.program = create_shader_program(blur_vertex_shader, distortion_fragment_shader);    setup_quad(&distortion_effect);    setup_framebuffer(&distortion_effect, width, height);    // Inicializar efeito de scanline    scanline_effect.program = create_shader_program(blur_vertex_shader, scanline_fragment_shader);    setup_quad(&scanline_effect);    setup_framebuffer(&scanline_effect, width, height);    return 0;}void gui_effects_shutdown(){    // Liberar recursos do efeito de blur    glDeleteProgram(blur_effect.program);    glDeleteVertexArrays(1, &blur_effect.vao);    glDeleteBuffers(1, &blur_effect.vbo);    glDeleteFramebuffers(1, &blur_effect.fbo);    glDeleteTextures(1, &blur_effect.texture);    // Liberar recursos do efeito de bloom    glDeleteProgram(bloom_effect.program);    glDeleteVertexArrays(1, &bloom_effect.vao);    glDeleteBuffers(1, &bloom_effect.vbo);    glDeleteFramebuffers(1, &bloom_effect.fbo);    glDeleteTextures(1, &bloom_effect.texture);    // Liberar recursos do efeito de distorção    glDeleteProgram(distortion_effect.program);    glDeleteVertexArrays(1, &distortion_effect.vao);    glDeleteBuffers(1, &distortion_effect.vbo);    glDeleteFramebuffers(1, &distortion_effect.fbo);    glDeleteTextures(1, &distortion_effect.texture);    // Liberar recursos do efeito de scanline    glDeleteProgram(scanline_effect.program);    glDeleteVertexArrays(1, &scanline_effect.vao);    glDeleteBuffers(1, &scanline_effect.vbo);    glDeleteFramebuffers(1, &scanline_effect.fbo);    glDeleteTextures(1, &scanline_effect.texture);}void gui_effects_apply_blur(SDL_Texture *texture, float blur_size){    glUseProgram(blur_effect.program);    glUniform1f(glGetUniformLocation(blur_effect.program, "blurSize"), blur_size);    glBindFramebuffer(GL_FRAMEBUFFER, blur_effect.fbo);    glClear(GL_COLOR_BUFFER_BIT);    glBindVertexArray(blur_effect.vao);    glActiveTexture(GL_TEXTURE0);    glBindTexture(GL_TEXTURE_2D, blur_effect.texture);    glUniform1i(glGetUniformLocation(blur_effect.program, "screenTexture"), 0);    glDrawArrays(GL_TRIANGLE_FAN, 0, 4);}void gui_effects_apply_bloom(SDL_Texture *texture, float threshold, float intensity){    glUseProgram(bloom_effect.program);    glUniform1f(glGetUniformLocation(bloom_effect.program, "threshold"), threshold);    glUniform1f(glGetUniformLocation(bloom_effect.program, "intensity"), intensity);    glBindFramebuffer(GL_FRAMEBUFFER, bloom_effect.fbo);    glClear(GL_COLOR_BUFFER_BIT);    glBindVertexArray(bloom_effect.vao);    glActiveTexture(GL_TEXTURE0);    glBindTexture(GL_TEXTURE_2D, bloom_effect.texture);    glUniform1i(glGetUniformLocation(bloom_effect.program, "screenTexture"), 0);    glDrawArrays(GL_TRIANGLE_FAN, 0, 4);}void gui_effects_apply_distortion(SDL_Texture *texture, float time, float amount){    glUseProgram(distortion_effect.program);    glUniform1f(glGetUniformLocation(distortion_effect.program, "time"), time);    glUniform1f(glGetUniformLocation(distortion_effect.program, "amount"), amount);    glBindFramebuffer(GL_FRAMEBUFFER, distortion_effect.fbo);    glClear(GL_COLOR_BUFFER_BIT);    glBindVertexArray(distortion_effect.vao);    glActiveTexture(GL_TEXTURE0);    glBindTexture(GL_TEXTURE_2D, distortion_effect.texture);    glUniform1i(glGetUniformLocation(distortion_effect.program, "screenTexture"), 0);    glDrawArrays(GL_TRIANGLE_FAN, 0, 4);}void gui_effects_apply_scanlines(SDL_Texture *texture, float intensity, float count){    glUseProgram(scanline_effect.program);    glUniform1f(glGetUniformLocation(scanline_effect.program, "scanlineIntensity"), intensity);    glUniform1f(glGetUniformLocation(scanline_effect.program, "scanlineCount"), count);    glBindFramebuffer(GL_FRAMEBUFFER, scanline_effect.fbo);    glClear(GL_COLOR_BUFFER_BIT);    glBindVertexArray(scanline_effect.vao);    glActiveTexture(GL_TEXTURE0);    glBindTexture(GL_TEXTURE_2D, scanline_effect.texture);    glUniform1i(glGetUniformLocation(scanline_effect.program, "screenTexture"), 0);    glDrawArrays(GL_TRIANGLE_FAN, 0, 4);}