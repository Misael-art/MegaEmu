#include <SDL2/SDL.h>#include <string.h>#include "nes_renderer.h"#include "../../utils/enhanced_log.h"static struct{    SDL_Window *window;    SDL_Renderer *renderer;    SDL_Texture *game_texture;    int window_width;    int window_height;    int scale_factor;    bool vsync_enabled;    bool fullscreen;} g_renderer = {0};int32_t nes_renderer_init(SDL_Window *window, SDL_Renderer *renderer){    if (!window || !renderer)    {        SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Parâmetros inválidos para inicialização do renderer");        return -1;    }    g_renderer.window = window;    g_renderer.renderer = renderer;    g_renderer.scale_factor = NES_DEFAULT_SCALE;    g_renderer.vsync_enabled = NES_ENABLE_VSYNC;    g_renderer.fullscreen = NES_ENABLE_FULLSCREEN;    SDL_GetWindowSize(window, &g_renderer.window_width, &g_renderer.window_height);    // Criar textura para o jogo    g_renderer.game_texture = SDL_CreateTexture(        renderer,        SDL_PIXELFORMAT_ARGB8888,        SDL_TEXTUREACCESS_STREAMING,        NES_SCREEN_WIDTH,        NES_SCREEN_HEIGHT);    if (!g_renderer.game_texture)    {        SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Falha ao criar textura do jogo: %s", SDL_GetError());        return -1;    }    // Configurar qualidade de renderização    SDL_SetHint(SDL_HINT_RENDER_SCALE_QUALITY, "nearest");    SDL_RenderSetLogicalSize(renderer, NES_SCREEN_WIDTH * g_renderer.scale_factor,                             NES_SCREEN_HEIGHT * g_renderer.scale_factor);    SDL_Log("Renderer NES inicializado com sucesso");    return 0;}void nes_renderer_shutdown(void){    if (g_renderer.game_texture)    {        SDL_DestroyTexture(g_renderer.game_texture);        g_renderer.game_texture = NULL;    }    SDL_Log("Renderer NES finalizado");}int32_t nes_renderer_render_frame(const uint32_t *frame_buffer){    if (!frame_buffer)    {        SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Frame buffer inválido");        return -1;    }    // Atualizar textura com o novo frame    void *pixels;    int pitch;    if (SDL_LockTexture(g_renderer.game_texture, NULL, &pixels, &pitch) < 0)    {        SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Falha ao bloquear textura: %s", SDL_GetError());        return -1;    }    // Copiar pixels do frame buffer para a textura    memcpy(pixels, frame_buffer, NES_SCREEN_WIDTH * NES_SCREEN_HEIGHT * sizeof(uint32_t));    SDL_UnlockTexture(g_renderer.game_texture);    // Limpar o renderer    SDL_RenderClear(g_renderer.renderer);    // Renderizar a textura do jogo    SDL_Rect dest = {        .x = 0,        .y = 0,        .w = NES_SCREEN_WIDTH * g_renderer.scale_factor,        .h = NES_SCREEN_HEIGHT * g_renderer.scale_factor};    SDL_RenderCopy(g_renderer.renderer, g_renderer.game_texture, NULL, &dest);    SDL_RenderPresent(g_renderer.renderer);    return 0;}void nes_renderer_resize(int width, int height){    g_renderer.window_width = width;    g_renderer.window_height = height;    // Recalcular escala mantendo proporção    float window_aspect = (float)width / height;    float nes_aspect = NES_ASPECT_RATIO;    SDL_Rect viewport;    if (window_aspect > nes_aspect)    {        viewport.h = height;        viewport.w = (int)(height * nes_aspect);    }    else    {        viewport.w = width;        viewport.h = (int)(width / nes_aspect);    }    viewport.x = (width - viewport.w) / 2;    viewport.y = (height - viewport.h) / 2;    SDL_RenderSetViewport(g_renderer.renderer, &viewport);}void nes_renderer_set_fullscreen(bool fullscreen){    if (g_renderer.fullscreen != fullscreen)    {        g_renderer.fullscreen = fullscreen;        SDL_SetWindowFullscreen(g_renderer.window,                                fullscreen ? SDL_WINDOW_FULLSCREEN_DESKTOP : 0);    }}void nes_renderer_set_scale(int scale){    if (scale < 1)        scale = 1;    if (scale > 4)        scale = 4;    if (g_renderer.scale_factor != scale)    {        g_renderer.scale_factor = scale;        SDL_RenderSetLogicalSize(g_renderer.renderer,                                 NES_SCREEN_WIDTH * scale,                                 NES_SCREEN_HEIGHT * scale);    }}void nes_renderer_set_vsync(bool enabled){    if (g_renderer.vsync_enabled != enabled)    {        g_renderer.vsync_enabled = enabled;        // Recriar o renderer com as novas configurações        SDL_DestroyRenderer(g_renderer.renderer);        g_renderer.renderer = SDL_CreateRenderer(g_renderer.window, -1,                                                 SDL_RENDERER_ACCELERATED | (enabled ? SDL_RENDERER_PRESENTVSYNC : 0));        if (!g_renderer.renderer)        {            SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Falha ao recriar renderer: %s", SDL_GetError());            return;        }        // Recriar a textura do jogo        if (g_renderer.game_texture)        {            SDL_DestroyTexture(g_renderer.game_texture);        }        g_renderer.game_texture = SDL_CreateTexture(            g_renderer.renderer,            SDL_PIXELFORMAT_ARGB8888,            SDL_TEXTUREACCESS_STREAMING,            NES_SCREEN_WIDTH,            NES_SCREEN_HEIGHT);        if (!g_renderer.game_texture)        {            SDL_LogError(SDL_LOG_CATEGORY_RENDER, "Falha ao recriar textura: %s", SDL_GetError());            return;        }        SDL_SetHint(SDL_HINT_RENDER_SCALE_QUALITY, "nearest");        SDL_RenderSetLogicalSize(g_renderer.renderer,                                 NES_SCREEN_WIDTH * g_renderer.scale_factor,                                 NES_SCREEN_HEIGHT * g_renderer.scale_factor);    }}