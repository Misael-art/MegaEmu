/** * @file md_core.c * @brief Implementação da interface C para a plataforma Mega Drive * @author Mega_Emu Team * @version 1.0.0 * @date 2024-03-13 */#include "md_core.h"#include "../../utils/common_types.h"#include "../../utils/error_handling.h"#include <stdlib.h>#include <string.h>#include <stdint.h>#include <stddef.h>// Definição do tipo opaco megadrive_tstruct megadrive_t{    void *cpp_instance; // Ponteiro para a instância C++    bool initialized;   // Flag de inicialização};// Funções de ponte para C++, implementadas em cpp_to_c_bridge.cppextern void *md_cpp_create(void);extern void md_cpp_destroy(void *instance);extern int md_cpp_initialize(void *instance);extern int md_cpp_load_rom(void *instance, const uint8_t *data, size_t size);extern int md_cpp_run_frame(void *instance);extern const uint32_t *md_cpp_get_video_buffer(void *instance);extern void md_cpp_update_controller(void *instance, const void *controller_state, int controller_index);extern int md_cpp_save_state(void *instance, const char *filename);extern int md_cpp_load_state(void *instance, const char *filename);megadrive_t *megadrive_create(void){    megadrive_t *md = (megadrive_t *)malloc(sizeof(megadrive_t));    if (!md)    {        emu_error_set(EMU_ERROR_MEMORY, "Falha ao alocar estrutura megadrive_t", __FILE__, __LINE__);        return NULL;    }    md->cpp_instance = md_cpp_create();    if (!md->cpp_instance)    {        emu_error_set(EMU_ERROR_GENERIC, "Falha ao criar instância C++", __FILE__, __LINE__);        free(md);        return NULL;    }    md->initialized = false;    return md;}void megadrive_destroy(megadrive_t *md){    if (md)    {        if (md->cpp_instance)        {            md_cpp_destroy(md->cpp_instance);        }        free(md);    }}emu_error_t megadrive_init(megadrive_t *md){    if (!md)    {        emu_error_set(EMU_ERROR_INVALID_PARAMETER, "Ponteiro megadrive_t é NULL", __FILE__, __LINE__);        return EMU_ERROR_INVALID_PARAMETER;    }    if (md->initialized)    {        emu_error_set(EMU_ERROR_ALREADY_INITIALIZED, "Mega Drive já foi inicializado", __FILE__, __LINE__);        return EMU_ERROR_ALREADY_INITIALIZED;    }    if (!md->cpp_instance)    {        emu_error_set(EMU_ERROR_NOT_INITIALIZED, "Instância C++ não foi criada", __FILE__, __LINE__);        return EMU_ERROR_NOT_INITIALIZED;    }    if (!md_cpp_initialize(md->cpp_instance))    {        emu_error_set(EMU_ERROR_GENERIC, "Falha ao inicializar instância C++", __FILE__, __LINE__);        return EMU_ERROR_GENERIC;    }    md->initialized = true;    return EMU_ERROR_NONE;}emu_error_t megadrive_load_rom(megadrive_t *md, const uint8_t *data, size_t size){    if (!md || !data)    {        emu_error_set(EMU_ERROR_INVALID_PARAMETER, "Parâmetros inválidos", __FILE__, __LINE__);        return EMU_ERROR_INVALID_PARAMETER;    }    if (!md->initialized)    {        emu_error_set(EMU_ERROR_NOT_INITIALIZED, "Mega Drive não foi inicializado", __FILE__, __LINE__);        return EMU_ERROR_NOT_INITIALIZED;    }    if (!md_cpp_load_rom(md->cpp_instance, data, size))    {        emu_error_set(EMU_ERROR_GENERIC, "Falha ao carregar ROM", __FILE__, __LINE__);        return EMU_ERROR_GENERIC;    }    return EMU_ERROR_NONE;}emu_error_t megadrive_run_frame(megadrive_t *md){    if (!md)    {        emu_error_set(EMU_ERROR_INVALID_PARAMETER, "Ponteiro megadrive_t é NULL", __FILE__, __LINE__);        return EMU_ERROR_INVALID_PARAMETER;    }    if (!md->initialized)    {        emu_error_set(EMU_ERROR_NOT_INITIALIZED, "Mega Drive não foi inicializado", __FILE__, __LINE__);        return EMU_ERROR_NOT_INITIALIZED;    }    if (!md_cpp_run_frame(md->cpp_instance))    {        emu_error_set(EMU_ERROR_GENERIC, "Falha ao executar frame", __FILE__, __LINE__);        return EMU_ERROR_GENERIC;    }    return EMU_ERROR_NONE;}const uint32_t *megadrive_get_video_buffer(const megadrive_t *md){    if (!md || !md->cpp_instance)    {        return NULL;    }    return md_cpp_get_video_buffer(md->cpp_instance);}void megadrive_update_controller(megadrive_t *md, const void *controller_state, int controller_index){    if (!md || !md->cpp_instance || !controller_state || controller_index < 0 || controller_index > 3)    {        return;    }    md_cpp_update_controller(md->cpp_instance, controller_state, controller_index);}emu_error_t megadrive_save_state(megadrive_t *md, const char *filename){    if (!md || !md->cpp_instance || !filename)    {        return EMU_ERROR_INVALID_PARAMETER;    }    return md_cpp_save_state(md->cpp_instance, filename) ? EMU_SUCCESS : EMU_ERROR_FILE_OPERATION_FAILED;}emu_error_t megadrive_load_state(megadrive_t *md, const char *filename){    if (!md || !md->cpp_instance || !filename)    {        return EMU_ERROR_INVALID_PARAMETER;    }    return md_cpp_load_state(md->cpp_instance, filename) ? EMU_SUCCESS : EMU_ERROR_FILE_OPERATION_FAILED;}