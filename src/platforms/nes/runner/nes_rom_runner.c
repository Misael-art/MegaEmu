/** * @file nes_rom_runner.c * @brief Programa para executar ROMs NES de um diretório específico */#include <stdio.h>#include <stdlib.h>#include <string.h>#include <dirent.h>#include "platforms/nes/nes.h"#include "utils/enhanced_log.h"#define MAX_ROMS 100#define MAX_PATH_LENGTH 512#define NES_SCREEN_WIDTH 256#define NES_SCREEN_HEIGHT 240#define AUDIO_BUFFER_SIZE (44100 / 60)/** * @brief Estrutura para armazenar informações das ROMs */typedef struct{    char filename[MAX_PATH_LENGTH];    char path[MAX_PATH_LENGTH];} rom_info_t;/** * @brief Carrega a lista de ROMs de um diretório * * @param directory_path Caminho para o diretório * @param roms Array para armazenar informações das ROMs * @return int Número de ROMs encontradas */int load_rom_list(const char *directory_path, rom_info_t *roms){    DIR *dir;    struct dirent *entry;    int rom_count = 0;    dir = opendir(directory_path);    if (!dir)    {        printf("Erro ao abrir diretório: %s\n", directory_path);        return 0;    }    while ((entry = readdir(dir)) != NULL && rom_count < MAX_ROMS)    {        // Verifica se é um arquivo .nes        const char *ext = strrchr(entry->d_name, '.');        if (ext && strcmp(ext, ".nes") == 0)        {            // Copia o nome do arquivo            strncpy(roms[rom_count].filename, entry->d_name, MAX_PATH_LENGTH - 1);            roms[rom_count].filename[MAX_PATH_LENGTH - 1] = '\0';            // Cria o caminho completo            snprintf(roms[rom_count].path, MAX_PATH_LENGTH, "%s/%s", directory_path, entry->d_name);            rom_count++;        }    }    closedir(dir);    return rom_count;}/** * @brief Exibe o menu de seleção de ROMs * * @param roms Array com informações das ROMs * @param rom_count Número de ROMs disponíveis * @return int Índice da ROM selecionada ou -1 para sair */int show_rom_menu(rom_info_t *roms, int rom_count){    int selection;    printf("\n===== Mega_Emu - Seletor de ROMs NES =====\n\n");    for (int i = 0; i < rom_count; i++)    {        printf("%d. %s\n", i + 1, roms[i].filename);    }    printf("\n0. Sair\n");    printf("\nEscolha uma ROM para executar: ");    if (scanf("%d", &selection) != 1)    {        // Limpa o buffer de entrada em caso de erro        int c;        while ((c = getchar()) != '\n' && c != EOF)            ;        return -1;    }    if (selection < 0 || selection > rom_count)    {        printf("Seleção inválida!\n");        return -1;    }    if (selection == 0)    {        return -1; // Sair    }    return selection - 1;}/** * @brief Executa uma ROM NES * * @param rom_path Caminho para a ROM * @return int 0 em caso de sucesso, código de erro caso contrário */int run_nes_rom(const char *rom_path){    // Configuração do NES    nes_config_t config;    memset(&config, 0, sizeof(config));    config.ntsc_mode = 1;    config.audio_enabled = 1;    config.log_level = EMU_LOG_LEVEL_INFO;    // Inicializa o sistema NES    if (nes_init(&config) != 0)    {        printf("Erro ao inicializar o sistema NES\n");        return 1;    }    // Carrega a ROM    if (nes_load_rom(rom_path) != 0)    {        printf("Erro ao carregar a ROM: %s\n", rom_path);        nes_shutdown();        return 1;    }    printf("ROM carregada com sucesso: %s\n", rom_path);    // Obtém informações sobre a ROM    const nes_state_t *state = nes_get_state();    printf("Informações da ROM:\n");    printf("  Mapper: %d\n", state->rom_info.mapper_number);    printf("  PRG ROM: %d KB\n", state->rom_info.prg_rom_size / 1024);    printf("  CHR ROM: %d KB\n", state->rom_info.chr_rom_size / 1024);    // Aloca buffer para o frame    uint32_t *frame_buffer = (uint32_t *)malloc(NES_SCREEN_WIDTH * NES_SCREEN_HEIGHT * sizeof(uint32_t));    if (!frame_buffer)    {        printf("Erro ao alocar buffer de frame\n");        nes_shutdown();        return 1;    }    // Aloca buffer para áudio    int16_t *audio_buffer = (int16_t *)malloc(AUDIO_BUFFER_SIZE * sizeof(int16_t));    if (!audio_buffer)    {        printf("Erro ao alocar buffer de áudio\n");        free(frame_buffer);        nes_shutdown();        return 1;    }    printf("\nPressionando botões automaticamente para testar controles...\n");    // Executa alguns frames com diferentes estados de botões para teste    for (int i = 0; i < 60; i++)    {        // Simula alguns botões pressionados a cada 10 frames        if (i % 10 == 0)        {            uint8_t button_state = 0;            // Alterna entre diferentes botões            switch ((i / 10) % 4)            {            case 0:                button_state = NES_BUTTON_A;                break; // A            case 1:                button_state = NES_BUTTON_B | NES_BUTTON_RIGHT; // B + Direita            case 2:                button_state = NES_BUTTON_LEFT; // Esquerda            case 3:                button_state = NES_BUTTON_START; // Start            }            nes_set_controller1(button_state);            printf("Frame %d: Botões = 0x%02X\n", i, button_state);        }        // Executa um frame        nes_run_frame(frame_buffer, audio_buffer, AUDIO_BUFFER_SIZE);    }    printf("\nPara interação real, este programa deveria ser integrado a uma interface gráfica.\n");    printf("Este é apenas um teste de execução das ROMs.\n");    printf("\nPresione ENTER para continuar...");    getchar(); // Consome o newline anterior    getchar(); // Aguarda Enter    // Libera recursos    free(audio_buffer);    free(frame_buffer);    nes_shutdown();    return 0;}/** * @brief Função principal */int main(int argc, char *argv[]){    char rom_directory[MAX_PATH_LENGTH];    rom_info_t roms[MAX_ROMS];    int rom_count;    int selected_rom;    // Define o diretório padrão de ROMs    strncpy(rom_directory, "D:/Steamapps/Dev/PC Engines Projects/Mega_Emu/roms/nes", MAX_PATH_LENGTH - 1);    rom_directory[MAX_PATH_LENGTH - 1] = '\0';    // Verifica se foi fornecido um diretório como argumento    if (argc > 1)    {        strncpy(rom_directory, argv[1], MAX_PATH_LENGTH - 1);        rom_directory[MAX_PATH_LENGTH - 1] = '\0';    }    printf("Carregando ROMs do diretório: %s\n", rom_directory);    // Carrega a lista de ROMs    rom_count = load_rom_list(rom_directory, roms);    if (rom_count == 0)    {        printf("Nenhuma ROM NES encontrada no diretório!\n");        return 1;    }    printf("Encontradas %d ROMs NES.\n", rom_count);    // Loop principal    while (1)    {        selected_rom = show_rom_menu(roms, rom_count);        if (selected_rom < 0)        {            break; // Sai do programa        }        run_nes_rom(roms[selected_rom].path);    }    printf("Programa finalizado.\n");    return 0;}