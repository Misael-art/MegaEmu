/** * @file test_save_state.c * @brief Testes para o sistema de save states */#include <stdio.h>#include <stdlib.h>#include <string.h>#include <assert.h>#include "../utils/md5.h"#include "../platforms/nes/save/nes_save_state.h"#include "../platforms/nes/nes.h"#include "../utils/enhanced_log.h"// Arquivo temporário para testes#define TEST_SAVE_FILE "test_save.state"static void test_save_state_init(void){    printf("Testing save state system initialization...\n");    int result = nes_save_state_init();    assert(result == NES_SAVE_STATE_ERROR_NONE);    printf("[OK] Initialization test passed\n");}static void test_save_state_save_load(void){    printf("Testing save state save and load...\n");    // Primeiro precisamos ter um estado válido do NES    nes_config_t config = {0};    config.ntsc_mode = 1;    printf("Initializing NES...\n");    int result = nes_init(&config);    if (result != NES_ERROR_NONE)    {        printf("Failed to initialize NES: error code %d\n", result);        return;    }    printf("Allocating cartridge...\n");    // Inicializa o estado manualmente para teste    g_nes_state.cartridge = (nes_cartridge_t *)malloc(sizeof(nes_cartridge_t));    if (!g_nes_state.cartridge)    {        printf("Failed to allocate cartridge\n");        return;    }    memset(g_nes_state.cartridge, 0, sizeof(nes_cartridge_t));    printf("Allocating PRG ROM...\n");    g_nes_state.cartridge->prg_rom = (uint8_t *)malloc(16384); // 16KB    if (!g_nes_state.cartridge->prg_rom)    {        printf("Failed to allocate PRG ROM\n");        free(g_nes_state.cartridge);        return;    }    g_nes_state.cartridge->prg_rom_size = 16384;    memset(g_nes_state.cartridge->prg_rom, 0xAA, 16384); // Preenche com um padrão    // Inicializa outros campos do cartucho    g_nes_state.cartridge->mapper_number = NES_MAPPER_NROM;    g_nes_state.cartridge->prg_ram = (uint8_t *)malloc(8192); // 8KB de PRG RAM    if (!g_nes_state.cartridge->prg_ram)    {        printf("Failed to allocate PRG RAM\n");        free(g_nes_state.cartridge->prg_rom);        free(g_nes_state.cartridge);        return;    }    memset(g_nes_state.cartridge->prg_ram, 0x55, 8192);    printf("Allocating CPU...\n");    g_nes_state.cpu = (nes_cpu_t *)malloc(sizeof(nes_cpu_t));    if (!g_nes_state.cpu)    {        printf("Failed to allocate CPU\n");        free(g_nes_state.cartridge->prg_ram);        free(g_nes_state.cartridge->prg_rom);        free(g_nes_state.cartridge);        return;    }    memset(g_nes_state.cpu, 0, sizeof(nes_cpu_t));    printf("Setting test values...\n");    // Modifica alguns valores para testar    g_nes_state.cpu->a = 0x42;    g_nes_state.cpu->x = 0x69;    g_nes_state.cpu->pc = 0x8000;    printf("Saving state...\n");    // Salva o estado    result = nes_save_state_save(TEST_SAVE_FILE);    if (result != NES_SAVE_STATE_ERROR_NONE)    {        printf("Failed to save state: error code %d\n", result);        free(g_nes_state.cpu);        free(g_nes_state.cartridge->prg_ram);        free(g_nes_state.cartridge->prg_rom);        free(g_nes_state.cartridge);        return;    }    printf("[OK] Save test passed\n");    printf("Modifying test values...\n");    // Modifica os valores    g_nes_state.cpu->a = 0x00;    g_nes_state.cpu->x = 0x00;    g_nes_state.cpu->pc = 0x0000;    printf("Loading state...\n");    // Carrega o estado    result = nes_save_state_load(TEST_SAVE_FILE);    if (result != NES_SAVE_STATE_ERROR_NONE)    {        printf("Failed to load state: error code %d\n", result);        free(g_nes_state.cpu);        free(g_nes_state.cartridge->prg_ram);        free(g_nes_state.cartridge->prg_rom);        free(g_nes_state.cartridge);        return;    }    printf("Verifying values...\n");    // Verifica se os valores foram restaurados    if (g_nes_state.cpu->a != 0x42 || g_nes_state.cpu->x != 0x69 || g_nes_state.cpu->pc != 0x8000)    {        printf("Values mismatch: a=0x%02X (expected 0x42), x=0x%02X (expected 0x69), pc=0x%04X (expected 0x8000)\n",               g_nes_state.cpu->a, g_nes_state.cpu->x, g_nes_state.cpu->pc);        free(g_nes_state.cpu);        free(g_nes_state.cartridge->prg_ram);        free(g_nes_state.cartridge->prg_rom);        free(g_nes_state.cartridge);        return;    }    printf("[OK] Load test passed\n");    printf("Cleaning up...\n");    // Limpa    remove(TEST_SAVE_FILE);    free(g_nes_state.cartridge->prg_ram);    free(g_nes_state.cartridge->prg_rom);    free(g_nes_state.cartridge);    free(g_nes_state.cpu);    nes_shutdown();}static void test_save_state_validation(void){    printf("Testing save state file validation...\n");    // Arquivo inválido não deve existir    assert(nes_save_state_validate("nao_existe.state") == false);    // Cria um arquivo com conteúdo inválido    FILE *file = fopen(TEST_SAVE_FILE, "wb");    assert(file != NULL);    char invalid_data[] = "INVALID";    fwrite(invalid_data, 1, strlen(invalid_data), file);    fclose(file);    // Arquivo com conteúdo inválido    assert(nes_save_state_validate(TEST_SAVE_FILE) == false);    // Limpa    remove(TEST_SAVE_FILE);    printf("[OK] Validation test passed\n");}int main(void){    // Inicializa o sistema de log    emu_log_config_t log_config = {        .level = EMU_LOG_LEVEL_DEBUG,        .output = stderr,        .flags = EMU_LOG_FLAG_USE_TIMESTAMP | EMU_LOG_FLAG_USE_LEVEL | EMU_LOG_FLAG_USE_CATEGORY    };    if (!emu_log_init(&log_config))    {        printf("Failed to initialize logging system\n");        return 1;    }    test_save_state_init();    test_save_state_save_load();    test_save_state_validation();    // Desliga o sistema de log    emu_log_shutdown();    return 0;}