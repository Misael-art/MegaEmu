/** * @file test_enhanced_log.c * @brief Testes unitários para o sistema de logging avançado */#include <stdio.h>#include <stdlib.h>#include <string.h>#include <assert.h>#include "../utils/enhanced_log.h"// Variáveis globais para o teste de callbackstatic int g_callback_called = 0;static int g_callback_level = -1;static char g_callback_message[1024] = {0};// Função de callback para testestatic void test_log_callback(int category, int level, const char *file, int line,                              const char *function, const char *message, void *userdata){    g_callback_called++;    g_callback_level = level;    strncpy(g_callback_message, message, sizeof(g_callback_message) - 1);    g_callback_message[sizeof(g_callback_message) - 1] = '\0';}// Função auxiliar para verificar se um arquivo contém uma stringstatic int file_contains_string(const char *filename, const char *search_str){    FILE *file = fopen(filename, "r");    if (!file)        return 0;    char line[1024];    int found = 0;    while (fgets(line, sizeof(line), file))    {        if (strstr(line, search_str) != NULL)        {            found = 1;            break;        }    }    fclose(file);    return found;}// Teste de inicialização e finalizaçãovoid test_init_shutdown(){    printf("Teste: Inicialização e finalização\n");    // Inicialização padrão (stderr)    int result = emu_log_init(NULL);    assert(result == 0);    assert(emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_INFO));    // Finalização    emu_log_shutdown();    assert(!emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_INFO));    // Inicialização com arquivo    result = emu_log_init("test.log");    assert(result == 0);    assert(emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_INFO));    // Finalização    emu_log_shutdown();    printf("  ✓ Inicialização e finalização OK\n");}// Teste de níveis de logvoid test_log_levels(){    printf("Teste: Níveis de log\n");    emu_log_init("test_levels.log");    // Teste dos níveis globais    emu_log_set_level(EMU_LOG_LEVEL_DEBUG);    assert(emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_DEBUG));    assert(emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_INFO));    assert(emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_WARN));    assert(!emu_enhanced_log_is_enabled(EMU_LOG_LEVEL_TRACE));    // Teste dos níveis por categoria    emu_log_set_category_level(EMU_LOG_CAT_CPU, EMU_LOG_LEVEL_TRACE);    assert(emu_enhanced_log_is_category_enabled(EMU_LOG_CAT_CPU, EMU_LOG_LEVEL_TRACE));    assert(!emu_enhanced_log_is_category_enabled(EMU_LOG_CAT_MEMORY, EMU_LOG_LEVEL_TRACE));    // Teste de todas as macros de log    LOG_TRACE(EMU_LOG_CAT_CPU, "Mensagem TRACE CPU"); // Deve aparecer (nível CPU = TRACE)    LOG_DEBUG(EMU_LOG_CAT_CPU, "Mensagem DEBUG CPU"); // Deve aparecer    LOG_INFO(EMU_LOG_CAT_CPU, "Mensagem INFO CPU");   // Deve aparecer    LOG_WARN(EMU_LOG_CAT_CPU, "Mensagem WARN CPU");   // Deve aparecer    LOG_ERROR(EMU_LOG_CAT_CPU, "Mensagem ERROR CPU"); // Deve aparecer    LOG_FATAL(EMU_LOG_CAT_CPU, "Mensagem FATAL CPU"); // Deve aparecer    LOG_TRACE(EMU_LOG_CAT_MEMORY, "Mensagem TRACE MEMORY"); // Não deve aparecer (nível MEMORY = DEBUG)    LOG_DEBUG(EMU_LOG_CAT_MEMORY, "Mensagem DEBUG MEMORY"); // Deve aparecer    LOG_INFO(EMU_LOG_CAT_MEMORY, "Mensagem INFO MEMORY");   // Deve aparecer    // Verificar se as mensagens corretas apareceram no arquivo    assert(file_contains_string("test_levels.log", "Mensagem TRACE CPU"));    assert(file_contains_string("test_levels.log", "Mensagem DEBUG CPU"));    assert(file_contains_string("test_levels.log", "Mensagem INFO MEMORY"));    assert(!file_contains_string("test_levels.log", "Mensagem TRACE MEMORY"));    emu_log_shutdown();    // Limpar arquivo de teste    remove("test_levels.log");    printf("  ✓ Níveis de log OK\n");}// Teste de flagsvoid test_log_flags(){    printf("Teste: Flags de configuração\n");    emu_log_init("test_flags.log");    // Configurar apenas timestamp e nível    emu_log_set_flags(EMU_LOG_FLAG_USE_TIMESTAMP | EMU_LOG_FLAG_USE_LEVEL);    LOG_INFO(EMU_LOG_CAT_CORE, "Mensagem apenas com timestamp e nível");    // Configurar todas as flags    emu_log_set_flags(EMU_LOG_FLAG_USE_ALL);    LOG_INFO(EMU_LOG_CAT_CORE, "Mensagem com todas as flags");    // Verificar no arquivo    assert(file_contains_string("test_flags.log", "Mensagem apenas com timestamp e nível"));    assert(file_contains_string("test_flags.log", "Mensagem com todas as flags"));    emu_log_shutdown();    // Limpar arquivo de teste    remove("test_flags.log");    printf("  ✓ Flags de configuração OK\n");}// Teste de callbackvoid test_log_callback(){    printf("Teste: Callback\n");    emu_log_init(NULL);    // Resetar variáveis de callback    g_callback_called = 0;    g_callback_level = -1;    memset(g_callback_message, 0, sizeof(g_callback_message));    // Configurar callback    emu_log_set_callback(test_log_callback, NULL);    // Enviar uma mensagem    const char *test_message = "Mensagem de teste para callback";    LOG_ERROR(EMU_LOG_CAT_CORE, test_message);    // Verificar se o callback foi chamado    assert(g_callback_called == 1);    assert(g_callback_level == EMU_LOG_LEVEL_ERROR);    assert(strstr(g_callback_message, test_message) != NULL);    // Desabilitar callback    emu_log_set_callback(NULL, NULL);    // Resetar variáveis de callback    g_callback_called = 0;    g_callback_level = -1;    memset(g_callback_message, 0, sizeof(g_callback_message));    // Enviar outra mensagem    LOG_ERROR(EMU_LOG_CAT_CORE, "Esta mensagem não deve chamar o callback");    // Verificar que o callback não foi chamado    assert(g_callback_called == 0);    emu_log_shutdown();    printf("  ✓ Callback OK\n");}// Teste de hexdumpvoid test_log_hexdump(){    printf("Teste: Hexdump\n");    emu_log_init("test_hexdump.log");    // Dados de teste    uint8_t test_data[] = {        0x00, 0x11, 0x22, 0x33, 0x44, 0x55, 0x66, 0x77,        0x88, 0x99, 0xAA, 0xBB, 0xCC, 0xDD, 0xEE, 0xFF,        0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48 // "ABCDEFGH"    };    // Log com hexdump    LOG_HEXDUMP_INFO(EMU_LOG_CAT_MEMORY, test_data, sizeof(test_data), "Dump de dados de teste");    // Verificar se o hexdump foi escrito    assert(file_contains_string("test_hexdump.log", "Dump de dados de teste"));    assert(file_contains_string("test_hexdump.log", "0000: 00 11 22 33"));    // Testar formatadores    char *hex_str = emu_log_format_hex(test_data, 8);    assert(strcmp(hex_str, "00 11 22 33 44 55 66 77") == 0);    free(hex_str);    char *bin_str = emu_log_format_binary(test_data, 2);    assert(strcmp(bin_str, "00000000 00010001") == 0);    free(bin_str);    emu_log_shutdown();    // Limpar arquivo de teste    remove("test_hexdump.log");    printf("  ✓ Hexdump OK\n");}// Teste de utilitáriosvoid test_log_utils(){    printf("Teste: Utilitários\n");    // Teste de conversão de nível para string    assert(strcmp(emu_log_level_to_string(EMU_LOG_LEVEL_INFO), "INFO") == 0);    assert(strcmp(emu_log_level_to_string(EMU_LOG_LEVEL_ERROR), "ERROR") == 0);    assert(strcmp(emu_log_level_to_string(99), "UNKNOWN") == 0);    // Teste de conversão de categoria para string    assert(strcmp(emu_log_category_to_string(EMU_LOG_CAT_CPU), "CPU") == 0);    assert(strcmp(emu_log_category_to_string(EMU_LOG_CAT_MEMORY), "MEMORY") == 0);    assert(strcmp(emu_log_category_to_string(99), "UNKNOWN") == 0);    printf("  ✓ Utilitários OK\n");}// Função principalint main(){    printf("=== Testes do Sistema de Logging Avançado ===\n\n");    test_init_shutdown();    test_log_levels();    test_log_flags();    test_log_callback();    test_log_hexdump();    test_log_utils();    printf("\n=== Todos os testes passaram com sucesso! ===\n");    return 0;}