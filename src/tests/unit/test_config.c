/** * @file test_config.c * @brief Testes unitários para o sistema de configuração */#include <stdio.h>#include <stdlib.h>#include <string.h>#include <assert.h>#include "core/config/config_interface.h"#include "test_common.h"// Variáveis para testesstatic int g_callback_called = 0;static char g_callback_key[128] = {0};static emu_config_value_t g_callback_value = {0};// Callback de testestatic void test_config_callback(const char *key, const emu_config_value_t *value, void *userdata){    g_callback_called = 1;    strncpy(g_callback_key, key, sizeof(g_callback_key) - 1);    // Copiar valor    if (value)    {        g_callback_value.type = value->type;        switch (value->type)        {        case EMU_CONFIG_TYPE_INT:            g_callback_value.int_value = value->int_value;            break;        case EMU_CONFIG_TYPE_FLOAT:            g_callback_value.float_value = value->float_value;            break;        case EMU_CONFIG_TYPE_BOOL:            g_callback_value.bool_value = value->bool_value;            break;        case EMU_CONFIG_TYPE_STRING:            if (g_callback_value.type == EMU_CONFIG_TYPE_STRING && g_callback_value.string_value)            {                free(g_callback_value.string_value);            }            if (value->string_value)            {                g_callback_value.string_value = strdup(value->string_value);            }            else            {                g_callback_value.string_value = NULL;            }            break;        default:            break;        }    }}// Inicializar e finalizar o testestatic void test_setup(void){    g_callback_called = 0;    memset(g_callback_key, 0, sizeof(g_callback_key));    if (g_callback_value.type == EMU_CONFIG_TYPE_STRING && g_callback_value.string_value)    {        free(g_callback_value.string_value);    }    memset(&g_callback_value, 0, sizeof(g_callback_value));}static void test_teardown(void){    if (g_callback_value.type == EMU_CONFIG_TYPE_STRING && g_callback_value.string_value)    {        free(g_callback_value.string_value);        g_callback_value.string_value = NULL;    }}// Teste de inicializaçãostatic void test_init(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    int result = config->init();    assert(result == 0);    // Tentar inicializar novamente    result = config->init();    assert(result == 0); // Deve retornar sucesso mesmo já inicializado    config->shutdown();}// Teste de valores inteirosstatic void test_int_values(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir valor    int result = config->set_int("test.int", 42);    assert(result == 0);    // Obter valor    int64_t value = 0;    result = config->get_int("test.int", &value);    assert(result == 0);    assert(value == 42);    // Tentar obter valor inexistente    result = config->get_int("test.nonexistent", &value);    assert(result == -1);    // Tentar obter valor de tipo incorreto    config->set_bool("test.bool", 1);    result = config->get_int("test.bool", &value);    assert(result == -1);    config->shutdown();}// Teste de valores de ponto flutuantestatic void test_float_values(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir valor    int result = config->set_float("test.float", 3.14159);    assert(result == 0);    // Obter valor    double value = 0;    result = config->get_float("test.float", &value);    assert(result == 0);    assert(value == 3.14159);    // Tentar obter valor inexistente    result = config->get_float("test.nonexistent", &value);    assert(result == -1);    // Tentar obter valor de tipo incorreto    config->set_int("test.int", 42);    result = config->get_float("test.int", &value);    assert(result == -1);    config->shutdown();}// Teste de valores booleanosstatic void test_bool_values(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir valor    int result = config->set_bool("test.bool", 1);    assert(result == 0);    // Obter valor    int value = 0;    result = config->get_bool("test.bool", &value);    assert(result == 0);    assert(value == 1);    // Definir valor falso    result = config->set_bool("test.bool", 0);    assert(result == 0);    // Obter valor    result = config->get_bool("test.bool", &value);    assert(result == 0);    assert(value == 0);    // Tentar obter valor inexistente    result = config->get_bool("test.nonexistent", &value);    assert(result == -1);    // Tentar obter valor de tipo incorreto    config->set_int("test.int", 42);    result = config->get_bool("test.int", &value);    assert(result == -1);    config->shutdown();}// Teste de valores de stringstatic void test_string_values(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir valor    int result = config->set_string("test.string", "Hello World");    assert(result == 0);    // Obter valor    char value[128];    result = config->get_string("test.string", value, sizeof(value));    assert(result == 0);    assert(strcmp(value, "Hello World") == 0);    // Tentar obter valor inexistente    result = config->get_string("test.nonexistent", value, sizeof(value));    assert(result == -1);    // Tentar obter valor de tipo incorreto    config->set_int("test.int", 42);    result = config->get_string("test.int", value, sizeof(value));    assert(result == -1);    config->shutdown();}// Teste de valores genéricosstatic void test_generic_values(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir valores de diferentes tipos    config->set_int("test.int", 42);    config->set_float("test.float", 3.14159);    config->set_bool("test.bool", 1);    config->set_string("test.string", "Hello World");    // Obter valores    emu_config_value_t value;    int result;    // Int    result = config->get_value("test.int", &value);    assert(result == 0);    assert(value.type == EMU_CONFIG_TYPE_INT);    assert(value.int_value == 42);    // Float    result = config->get_value("test.float", &value);    assert(result == 0);    assert(value.type == EMU_CONFIG_TYPE_FLOAT);    assert(value.float_value == 3.14159);    // Bool    result = config->get_value("test.bool", &value);    assert(result == 0);    assert(value.type == EMU_CONFIG_TYPE_BOOL);    assert(value.bool_value == 1);    // String    result = config->get_value("test.string", &value);    assert(result == 0);    assert(value.type == EMU_CONFIG_TYPE_STRING);    assert(strcmp(value.string_value, "Hello World") == 0);    free(value.string_value); // Liberar string alocada por get_value    config->shutdown();}// Teste de callbacksstatic void test_callbacks(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    test_setup();    config->init();    // Registrar callback    int result = config->register_change_callback("test.int", test_config_callback, NULL);    assert(result == 0);    // Definir valor para acionar callback    g_callback_called = 0;    result = config->set_int("test.int", 42);    assert(result == 0);    assert(g_callback_called == 1);    assert(strcmp(g_callback_key, "test.int") == 0);    assert(g_callback_value.type == EMU_CONFIG_TYPE_INT);    assert(g_callback_value.int_value == 42);    // Definir outro valor    g_callback_called = 0;    result = config->set_int("test.int", 100);    assert(result == 0);    assert(g_callback_called == 1);    assert(g_callback_value.int_value == 100);    // Definir valor que não deve acionar o callback    g_callback_called = 0;    result = config->set_int("test.other", 50);    assert(result == 0);    assert(g_callback_called == 0);    // Registrar callback para todos os valores    result = config->register_change_callback("*", test_config_callback, NULL);    assert(result == 0);    // Definir valor para acionar callback global    g_callback_called = 0;    result = config->set_int("test.other", 75);    assert(result == 0);    assert(g_callback_called == 1);    assert(strcmp(g_callback_key, "test.other") == 0);    assert(g_callback_value.type == EMU_CONFIG_TYPE_INT);    assert(g_callback_value.int_value == 75);    // Remover callback    result = config->unregister_change_callback("test.int", test_config_callback);    assert(result == 0);    // Definir valor que não deve mais acionar o callback específico    g_callback_called = 0;    result = config->set_int("test.int", 200);    assert(result == 0);    assert(g_callback_called == 1); // Mas ainda deve acionar o callback global    // Remover callback global    result = config->unregister_change_callback("*", test_config_callback);    assert(result == 0);    // Definir valor que não deve acionar nenhum callback    g_callback_called = 0;    result = config->set_int("test.int", 300);    assert(result == 0);    assert(g_callback_called == 0);    test_teardown();    config->shutdown();}// Teste de configurações padrãostatic void test_defaults(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Carregar configurações padrão    int result = config->load_defaults();    assert(result == 0);    // Verificar algumas configurações padrão    int64_t int_value;    double float_value;    int bool_value;    char string_value[128];    // Verificar valores de vídeo    result = config->get_int("video.width", &int_value);    assert(result == 0);    assert(int_value > 0);    result = config->get_int("video.height", &int_value);    assert(result == 0);    assert(int_value > 0);    // Verificar valores de áudio    result = config->get_int("audio.sample_rate", &int_value);    assert(result == 0);    assert(int_value > 0);    result = config->get_float("audio.volume", &float_value);    assert(result == 0);    assert(float_value >= 0.0 && float_value <= 1.0);    // Verificar caminhos    result = config->get_string("paths.roms", string_value, sizeof(string_value));    assert(result == 0);    assert(strlen(string_value) > 0);    config->shutdown();}// Teste de arquivo de configuraçãostatic void test_file_operations(void){    const emu_config_interface_t *config = emu_config_get_interface();    assert(config != NULL);    config->init();    // Definir alguns valores    config->set_int("test.int", 42);    config->set_float("test.float", 3.14159);    config->set_bool("test.bool", 1);    config->set_string("test.string", "Hello World");    // Salvar para arquivo    int result = config->save_to_file("test_config.cfg");    assert(result == 0);    // Limpar configurações    config->shutdown();    config->init();    // Carregar do arquivo    result = config->load_from_file("test_config.cfg");    assert(result == 0);    // Verificar valores    int64_t int_value;    double float_value;    int bool_value;    char string_value[128];    result = config->get_int("test.int", &int_value);    assert(result == 0);    assert(int_value == 42);    result = config->get_float("test.float", &float_value);    assert(result == 0);    assert(float_value == 3.14159);    result = config->get_bool("test.bool", &bool_value);    assert(result == 0);    assert(bool_value == 1);    result = config->get_string("test.string", string_value, sizeof(string_value));    assert(result == 0);    assert(strcmp(string_value, "Hello World") == 0);    // Limpar    config->shutdown();    remove("test_config.cfg");}// Função principal de testevoid test_config_run_all(void){    printf("Executando testes do sistema de configuração...\n");    test_init();    printf("✓ Teste de inicialização passou\n");    test_int_values();    printf("✓ Teste de valores inteiros passou\n");    test_float_values();    printf("✓ Teste de valores de ponto flutuante passou\n");    test_bool_values();    printf("✓ Teste de valores booleanos passou\n");    test_string_values();    printf("✓ Teste de valores de string passou\n");    test_generic_values();    printf("✓ Teste de valores genéricos passou\n");    test_callbacks();    printf("✓ Teste de callbacks passou\n");    test_defaults();    printf("✓ Teste de configurações padrão passou\n");    test_file_operations();    printf("✓ Teste de operações de arquivo passou\n");    printf("✓ Todos os testes do sistema de configuração passaram!\n\n");}